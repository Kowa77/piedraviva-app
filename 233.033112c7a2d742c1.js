"use strict";(self.webpackChunkpiedraviva_app=self.webpackChunkpiedraviva_app||[]).push([[233],{233:(Q,h,s)=>{s.r(h),s.d(h,{ShoppingCartComponent:()=>w});var m=s(467),g=s(2200),b=s(8132),C=s(4412),v=s(7673),_=s(6354),x=s(5558),y=s(6697),f=s(9330),t=s(3664),d=s(2615),P=s(6868),M=s(4796),k=s(1266);const I=(c,l)=>l.id;function E(c,l){if(1&c){const e=t.RV6();t.j41(0,"div",9),t.nrm(1,"img",14),t.j41(2,"div",15)(3,"h2",16),t.EFF(4),t.k0s(),t.j41(5,"p",17),t.EFF(6),t.nI1(7,"currency"),t.k0s()(),t.j41(8,"div",18)(9,"button",19),t.bIt("click",function(){const o=d.eBV(e).$implicit,r=t.XpG(3);return d.Njj(r.decrementQuantity(o))}),t.EFF(10,"-"),t.k0s(),t.j41(11,"input",20),t.bIt("input",function(o){const r=d.eBV(e).$implicit,i=t.XpG(3);return d.Njj(i.onQuantityChange(r,o))})("blur",function(o){const r=d.eBV(e).$implicit,i=t.XpG(3);return d.Njj(i.onQuantityBlur(r,o))}),t.k0s(),t.j41(12,"button",21),t.bIt("click",function(){const o=d.eBV(e).$implicit,r=t.XpG(3);return d.Njj(r.incrementQuantity(o))}),t.EFF(13,"+"),t.k0s(),t.j41(14,"button",22),t.bIt("click",function(){const o=d.eBV(e).$implicit,r=t.XpG(3);return d.Njj(r.removeItem(o))}),t.EFF(15,"Eliminar"),t.k0s()(),t.j41(16,"span",23),t.EFF(17),t.nI1(18,"currency"),t.k0s()()}if(2&c){const e=l.$implicit;t.R7$(),t.Y8G("src",e.imagenUrl||"https://placehold.co/100x100/FF5733/FFFFFF?text=Producto",t.B4B)("alt",e.nombre),t.R7$(3),t.JRh(e.nombre),t.R7$(2),t.JRh(t.ii3(7,6,e.precio,"UYU","$","1.2-2")),t.R7$(5),t.Y8G("value",0===e.cantidad?"":e.cantidad),t.R7$(6),t.JRh(t.ii3(18,11,e.precio*e.cantidad,"UYU","$","1.2-2"))}}function O(c,l){if(1&c){const e=t.RV6();t.j41(0,"div",8),t.Z7z(1,E,19,16,"div",9,I),t.k0s(),t.j41(3,"div",10)(4,"div",11)(5,"span"),t.EFF(6,"Total:"),t.k0s(),t.j41(7,"span",12),t.EFF(8),t.nI1(9,"async"),t.nI1(10,"currency"),t.k0s()(),t.j41(11,"button",13),t.bIt("click",function(){d.eBV(e);const o=t.XpG(2);return d.Njj(o.checkout())}),t.EFF(12,"Comprar Ahora"),t.k0s()()}if(2&c){const e=t.XpG(),n=t.XpG();t.R7$(),t.Dyx(e),t.R7$(7),t.JRh(t.ii3(10,3,t.bMT(9,1,n.totalAmount$),"UYU","$","1.2-2"))}}function $(c,l){1&c&&(t.j41(0,"div",7)(1,"p"),t.EFF(2,"Tu carrito est\xe1 vac\xedo. \xa1Agrega algunos productos deliciosos!"),t.k0s(),t.j41(3,"a",24),t.EFF(4,"Ver Men\xfa"),t.k0s()())}function F(c,l){1&c&&t.nVh(0,O,13,8)(1,$,5,0,"div",7),2&c&&t.vxM(l.length>0?0:1)}function S(c,l){1&c&&(t.j41(0,"div",5)(1,"p"),t.EFF(2,"Cargando tu carrito..."),t.k0s()())}function T(c,l){if(1&c){const e=t.RV6();t.j41(0,"div",6)(1,"button",25),t.bIt("click",function(){d.eBV(e);const o=t.XpG();return d.Njj(o.viewPurchaseHistory())}),t.EFF(2,"Ver Historial de Compras"),t.k0s()()}}let w=(()=>{class c{cartService;authService;router;http;cartItems$=new C.t([]);totalAmount$;currentUserSubscription;userId=null;showPurchaseHistoryButton=!1;editedQuantities=new Map;mercadoPagoBackendUrl="https://piedraviva-app-backend.onrender.com/create_preference";constructor(e,n,o,r){this.cartService=e,this.authService=n,this.router=o,this.http=r,this.totalAmount$=this.cartItems$.pipe((0,_.T)(i=>{const a=this.calculateTotal(i);return console.log("ShoppingCartComponent: Items being passed to calculateTotal (from totalAmount$ pipe):",i),console.log("ShoppingCartComponent: Calculated total (from totalAmount$ pipe):",a),a}))}ngOnInit(){this.currentUserSubscription=this.authService.user$.pipe((0,x.n)(e=>(this.userId=e?e.uid:null,console.log("ShoppingCartComponent: User ID after auth state change:",this.userId),this.userId?(this.checkPurchaseHistory(this.userId),this.cartService.getCart(this.userId)):(this.showPurchaseHistoryButton=!1,(0,v.of)([])))),(0,_.T)(e=>(this.editedQuantities.clear(),console.log("ShoppingCartComponent: Carrito recibido (items crudos) del servicio y procesado:",e),e))).subscribe(e=>{this.cartItems$.next(e)})}ngOnDestroy(){this.currentUserSubscription&&this.currentUserSubscription.unsubscribe(),this.cartItems$.complete()}checkPurchaseHistory(e){this.cartService.getPurchaseHistory(e).pipe((0,y.s)(1),(0,_.T)(n=>(console.log("ShoppingCartComponent: Historial de compras para checkPurchaseHistory:",n),n.length>0))).subscribe(n=>{this.showPurchaseHistoryButton=n,console.log("ShoppingCartComponent: \xbfTiene historial de compras?",n)})}calculateTotal(e){return console.log("calculateTotal: Recibiendo items para sumar:",e),e.reduce((n,o)=>{console.log(`calculateTotal: Sumando item: ${o.nombre}, Precio: ${o.precio}, Cantidad: ${o.cantidad}`);const a=("number"==typeof o.precio?o.precio:parseFloat(o.precio)||0)*("number"==typeof o.cantidad?o.cantidad:parseInt(o.cantidad,10)||0);return console.log(`calculateTotal: Subtotal para ${o.nombre}: ${a}`),n+a},0)}onQuantityChange(e,n){const o=n.target,r=o.value.trim();let i;if(""===r)i=0;else{const u=parseInt(r,10);if(isNaN(u)||u<0)return console.warn(`ShoppingCartComponent: Invalid entry for "${e.nombre}". Restored to ${e.cantidad}.`),void(o.value=String(e.cantidad));i=u}this.editedQuantities.set(e.id,i),console.log(`ShoppingCartComponent: Cantidad de "${e.nombre}" editada a ${i} (localmente).`);const a=this.cartItems$.getValue(),p=a.findIndex(u=>u.id===e.id);if(p>-1){const u=[...a];u[p]={...u[p],cantidad:i},this.cartItems$.next(u)}}onQuantityBlur(e,n){const o=n.target,r=o.value.trim();let i=parseInt(r,10);if(isNaN(i)||i<0)i=1,this.editedQuantities.set(e.id,i),o.value=String(i),console.log(`ShoppingCartComponent: Invalid input for "${e.nombre}" on blur. Restored to 1.`);else if(0===i)return this.removeItem(e),void this.editedQuantities.delete(e.id);this.hasEditedQuantity(e)?(console.log(`ShoppingCartComponent: onQuantityBlur triggered for "${e.nombre}". Saving quantity.`),this.saveQuantity(e)):i===e.cantidad&&this.editedQuantities.has(e.id)&&this.editedQuantities.delete(e.id)}incrementQuantity(e){let n=this.editedQuantities.get(e.id);void 0===n&&(n=e.cantidad);const o=n+1;this.editedQuantities.set(e.id,o);const r=this.cartItems$.getValue(),i=r.findIndex(a=>a.id===e.id);if(i>-1){const a=[...r];a[i]={...a[i],cantidad:o},this.cartItems$.next(a),this.saveQuantity(a[i])}console.log(`ShoppingCartComponent: Quantity of "${e.nombre}" incremented to ${o} (locally).`)}decrementQuantity(e){let n=this.editedQuantities.get(e.id);if(void 0===n&&(n=e.cantidad),n>0){const o=n-1;this.editedQuantities.set(e.id,o);const r=this.cartItems$.getValue(),i=r.findIndex(a=>a.id===e.id);if(i>-1){const a=[...r];a[i]={...a[i],cantidad:o},this.cartItems$.next(a),0===o?this.removeItem(a[i]):this.saveQuantity(a[i])}console.log(`ShoppingCartComponent: Quantity of "${e.nombre}" decremented to ${o} (locally).`)}else console.log(`ShoppingCartComponent: Quantity of "${e.nombre}" is already 0, cannot decrement further.`)}hasEditedQuantity(e){const n=this.editedQuantities.get(e.id);return void 0!==n&&n!==e.cantidad}saveQuantity(e){var n=this;return(0,m.A)(function*(){if(!n.userId||!e.id)return void alert("Error: No se pudo identificar al usuario o al producto.");const o=n.editedQuantities.get(e.id);if(void 0!==o){if(0===o)return n.removeItem(e),void n.editedQuantities.delete(e.id);if(isNaN(o)||o<0){alert("Por favor, ingresa una cantidad v\xe1lida (mayor o igual a cero)."),n.editedQuantities.delete(e.id);const r=n.cartItems$.getValue(),i=r.find(a=>a.id===e.id);if(i){const a=r.map(p=>p.id===e.id?{...p,cantidad:i.cantidad}:p);n.cartItems$.next(a)}return}try{yield n.cartService.updateItemQuantity(n.userId,e.id,o),console.log(`ShoppingCartComponent: Cantidad de "${e.nombre}" actualizada a ${o} en Firebase.`),n.editedQuantities.delete(e.id)}catch(r){console.error("ShoppingCartComponent: Error al actualizar la cantidad en Firebase:",r),alert("Error al actualizar la cantidad. Por favor, int\xe9ntalo de nuevo.")}}else console.log(`ShoppingCartComponent: No quantity change for "${e.nombre}" to save.`)})()}removeItem(e){var n=this;return(0,m.A)(function*(){if(n.userId&&e.id){if(confirm(`\xbfEst\xe1s seguro de que quieres eliminar "${e.nombre}" del carrito?`))try{yield n.cartService.removeItemFromCart(n.userId,e.id),alert(`"${e.nombre}" eliminado del carrito.`),console.log(`ShoppingCartComponent: "${e.nombre}" eliminado del carrito en Firebase.`),n.editedQuantities.delete(e.id)}catch(o){console.error("ShoppingCartComponent: Error al eliminar el item del carrito en Firebase:",o),alert("Error al eliminar el item del carrito. Por favor, int\xe9ntalo de nuevo.")}}else alert("Error: No se pudo identificar al usuario o al producto para eliminar.")})()}checkout(){var e=this;return(0,m.A)(function*(){if(!e.userId)return void alert("Debes iniciar sesi\xf3n para completar la compra.");const n=e.cartItems$.getValue();if(0===n.length)return void alert("Tu carrito est\xe1 vac\xedo. Agrega productos antes de comprar.");const o=n.map(r=>({title:r.nombre,quantity:r.cantidad,unit_price:r.precio}));try{const r=yield e.http.post(e.mercadoPagoBackendUrl,{items:o}).toPromise();r&&r.init_point?(console.log("Mercado Pago Preference created:",r.id),console.log("Redirecting to:",r.init_point),window.location.href=r.init_point):(alert("Error al iniciar el pago con Mercado Pago: No se recibi\xf3 un punto de inicio v\xe1lido."),console.error("Mercado Pago Backend response missing init_point:",r))}catch(r){console.error("Error al crear la preferencia de Mercado Pago:",r),alert("Ocurri\xf3 un error al procesar tu pago con Mercado Pago. Por favor, int\xe9ntalo de nuevo.")}})()}viewPurchaseHistory(){this.router.navigate(["/purchase-history"])}static \u0275fac=function(n){return new(n||c)(t.rXU(P.m),t.rXU(M.u),t.rXU(k.Ix),t.rXU(f.Qq))};static \u0275cmp=t.VBU({type:c,selectors:[["app-shopping-cart"]],decls:11,vars:4,consts:[[1,"cart-main-container"],[1,"cart-content-wrapper"],[1,"back-button-container"],["routerLink","/",1,"back-button"],[1,"cart-title"],[1,"loading-message-cart"],[1,"purchase-history-button-container"],[1,"empty-cart-message"],[1,"cart-items-grid"],[1,"cart-item-card"],[1,"cart-summary"],[1,"total-section"],[1,"total-amount"],[1,"checkout-button",3,"click"],[1,"cart-item-image",3,"src","alt"],[1,"item-details"],[1,"item-name"],[1,"item-price"],[1,"item-controls"],[1,"quantity-button","minus-button",3,"click"],["type","number","min","0",1,"item-quantity-input",3,"input","blur","value"],[1,"quantity-button","plus-button",3,"click"],[1,"remove-item-button",3,"click"],[1,"item-subtotal"],["routerLink","/",1,"back-to-menu-button"],[1,"view-history-button",3,"click"]],template:function(n,o){if(1&n&&(t.j41(0,"div",0)(1,"div",1)(2,"div",2)(3,"a",3),t.EFF(4,"\u2190 Seguir Comprando"),t.k0s()(),t.j41(5,"h1",4),t.EFF(6,"Tu Carrito de Compras"),t.k0s(),t.nVh(7,F,2,1),t.nI1(8,"async"),t.vZN(9,S,3,0,"div",5),t.nVh(10,T,3,0,"div",6),t.k0s()()),2&n){let r;t.R7$(7),t.vxM((r=t.bMT(8,2,o.cartItems$))?7:9,r),t.R7$(3),t.vxM(o.showPurchaseHistoryButton?10:-1)}},dependencies:[g.MD,b.Wk,f.q1,g.Jj,g.oe],styles:[".cart-main-container[_ngcontent-%COMP%]{min-height:100vh;background-color:#1a202c;color:#e2e8f0;padding:2rem;font-family:sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;display:flex;flex-direction:column;align-items:center}.cart-content-wrapper[_ngcontent-%COMP%]{max-width:800px;width:100%;margin:0 auto;background-color:#2d3748;border-radius:.5rem;box-shadow:0 20px 25px -5px #0000001a,0 10px 10px -5px #0000000a;overflow:hidden;padding:2rem;position:relative}.back-button-container[_ngcontent-%COMP%]{margin-bottom:1.5rem}.back-button[_ngcontent-%COMP%]{display:inline-block;background-color:#4a5568;color:#e2e8f0;padding:.75rem 1.5rem;border-radius:.5rem;text-decoration:none;font-weight:600;transition:background-color .3s ease}.back-button[_ngcontent-%COMP%]:hover{background-color:#64748b}.company-logo-container[_ngcontent-%COMP%]{text-align:center;margin-bottom:2rem}.company-logo[_ngcontent-%COMP%]{max-width:150px;height:auto;display:inline-block}.cart-title[_ngcontent-%COMP%]{font-size:2.5rem;font-weight:800;text-align:center;margin-bottom:2rem;color:#f6e05e;font-family:Pacifico,cursive;text-shadow:2px 2px 4px rgba(0,0,0,.5)}.cart-items-grid[_ngcontent-%COMP%]{display:grid;gap:1.5rem;margin-bottom:2rem}.cart-item-card[_ngcontent-%COMP%]{display:flex;align-items:center;background-color:#1a202c;border-radius:.5rem;box-shadow:0 5px 15px #0003;padding:1rem;gap:1rem;flex-wrap:wrap}.cart-item-image[_ngcontent-%COMP%]{width:80px;height:80px;border-radius:.375rem;object-fit:cover;flex-shrink:0}.item-details[_ngcontent-%COMP%]{flex-grow:1}.item-name[_ngcontent-%COMP%]{font-size:1.25rem;font-weight:700;color:#fff;margin-bottom:.25rem}.item-price[_ngcontent-%COMP%]{font-size:1rem;color:#a0aec0}.item-controls[_ngcontent-%COMP%]{display:flex;align-items:center;flex-shrink:0;margin-top:.5rem;width:100%;justify-content:center;border:1px solid #4a5568;border-radius:.375rem;overflow:hidden}@media (min-width: 640px){.item-controls[_ngcontent-%COMP%]{width:auto;margin-top:0;justify-content:flex-start}}.quantity-button[_ngcontent-%COMP%]{background-color:#4a5568;color:#fff;border:none;width:35px;height:35px;font-size:1.2rem;font-weight:700;cursor:pointer;transition:background-color .2s ease;display:flex;align-items:center;justify-content:center;flex-shrink:0}.quantity-button[_ngcontent-%COMP%]:hover{background-color:#64748b}.quantity-button.minus-button[_ngcontent-%COMP%]{border-top-left-radius:.375rem;border-bottom-left-radius:.375rem;border-top-right-radius:0;border-bottom-right-radius:0}.quantity-button.plus-button[_ngcontent-%COMP%]{border-top-right-radius:.375rem;border-bottom-right-radius:.375rem;border-top-left-radius:0;border-bottom-left-radius:0}.item-quantity-input[_ngcontent-%COMP%]{width:60px;padding:.5rem;border:none;border-radius:0;background-color:#1a202c;color:#e2e8f0;font-size:1rem;text-align:center;appearance:textfield;-moz-appearance:textfield;box-sizing:border-box}.item-quantity-input[_ngcontent-%COMP%]::-webkit-outer-spin-button, .item-quantity-input[_ngcontent-%COMP%]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}.remove-item-button[_ngcontent-%COMP%]{background-color:#e53e3e;color:#fff;padding:.5rem 1rem;border:none;border-radius:.375rem;font-size:.9rem;font-weight:600;cursor:pointer;transition:background-color .2s ease;margin-left:.75rem}.remove-item-button[_ngcontent-%COMP%]:hover{background-color:#c53030}.item-subtotal[_ngcontent-%COMP%]{font-size:1.25rem;font-weight:700;color:#f6e05e;flex-shrink:0;margin-left:auto}@media (max-width: 639px){.cart-item-card[_ngcontent-%COMP%]{flex-direction:column;align-items:flex-start}.item-details[_ngcontent-%COMP%]{width:100%}.item-subtotal[_ngcontent-%COMP%]{margin-left:0;width:100%;text-align:right;margin-top:.5rem}}.cart-summary[_ngcontent-%COMP%]{background-color:#1a202c;border-radius:.5rem;padding:1.5rem;box-shadow:0 5px 15px #0003;display:flex;flex-direction:column;gap:1.5rem}.total-section[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;font-size:1.5rem;font-weight:700;color:#fff}.total-amount[_ngcontent-%COMP%]{color:#f6e05e;font-size:2rem}.checkout-button[_ngcontent-%COMP%]{width:100%;background-color:#48bb78;color:#1a202c;padding:1rem 2rem;border:none;border-radius:.5rem;font-size:1.25rem;font-weight:700;cursor:pointer;transition:background-color .3s ease,transform .1s ease;box-shadow:0 4px 6px #0000001a}.checkout-button[_ngcontent-%COMP%]:hover{background-color:#38a169;transform:translateY(-2px)}.checkout-button[_ngcontent-%COMP%]:active{transform:translateY(0);box-shadow:0 2px 4px #0000001a}.empty-cart-message[_ngcontent-%COMP%], .loading-message-cart[_ngcontent-%COMP%]{text-align:center;padding:3rem;font-size:1.25rem;color:#a0aec0}.back-to-menu-button[_ngcontent-%COMP%]{display:inline-block;margin-top:1.5rem;background-color:#c53030;color:#fff;padding:.75rem 1.5rem;border-radius:.5rem;text-decoration:none;font-weight:600;transition:background-color .3s ease}.back-to-menu-button[_ngcontent-%COMP%]:hover{background-color:#a02020}.purchase-history-button-container[_ngcontent-%COMP%]{margin-top:2rem;text-align:center}.view-history-button[_ngcontent-%COMP%]{background-color:#007bff;color:#fff;padding:.75rem 1.5rem;border:none;border-radius:.5rem;font-size:1rem;font-weight:600;cursor:pointer;transition:background-color .3s ease,transform .1s ease;box-shadow:0 2px 4px #0000001a}.view-history-button[_ngcontent-%COMP%]:hover{background-color:#0056b3;transform:translateY(-1px)}.view-history-button[_ngcontent-%COMP%]:active{transform:translateY(0);box-shadow:0 1px 2px #0000001a}"]})}return c})()}}]);