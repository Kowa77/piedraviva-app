import{o as L,u as G}from"./chunk-XFMXKC7R.js";import{c as q,e as A,f as N,i as j,k as D,n as R,o as Y}from"./chunk-ECQRDTG2.js";import{$a as M,Ca as _,G as E,Ga as F,N as T,Va as w,Wa as z,Xa as S,Za as B,_a as U,a as b,aa as m,ab as a,b as C,ba as g,bb as c,cb as H,d as v,fb as I,jb as h,k as $,kb as u,nb as d,ob as x,s as Q,va as V,w as y,wb as f,xa as l,xb as O,zb as P}from"./chunk-G5SB7B44.js";var K=(s,t)=>t.id;function W(s,t){if(s&1){let e=I();a(0,"div",9),H(1,"img",14),a(2,"div",15)(3,"h2",16),d(4),c(),a(5,"p",17),d(6),f(7,"currency"),c()(),a(8,"div",18)(9,"button",19),h("click",function(){let o=m(e).$implicit,i=u(3);return g(i.decrementQuantity(o))}),d(10,"-"),c(),a(11,"input",20),h("input",function(o){let i=m(e).$implicit,r=u(3);return g(r.onQuantityChange(i,o))})("blur",function(o){let i=m(e).$implicit,r=u(3);return g(r.onQuantityBlur(i,o))}),c(),a(12,"button",21),h("click",function(){let o=m(e).$implicit,i=u(3);return g(i.incrementQuantity(o))}),d(13,"+"),c(),a(14,"button",22),h("click",function(){let o=m(e).$implicit,i=u(3);return g(i.removeItem(o))}),d(15,"Eliminar"),c()(),a(16,"span",23),d(17),f(18,"currency"),c()()}if(s&2){let e=t.$implicit;l(),M("src",e.imagenUrl||"https://placehold.co/100x100/FF5733/FFFFFF?text=Producto",V)("alt",e.nombre),l(3),x(e.nombre),l(2),x(P(7,6,e.precio,"UYU","$","1.2-2")),l(5),M("value",e.cantidad===0?"":e.cantidad),l(6),x(P(18,11,e.precio*e.cantidad,"UYU","$","1.2-2"))}}function X(s,t){if(s&1){let e=I();a(0,"div",8),B(1,W,19,16,"div",9,K),c(),a(3,"div",10)(4,"div",11)(5,"span"),d(6,"Total:"),c(),a(7,"span",12),d(8),f(9,"async"),f(10,"currency"),c()(),a(11,"button",13),h("click",function(){m(e);let o=u(2);return g(o.checkout())}),d(12,"Comprar Ahora"),c()()}if(s&2){let e=u(),n=u();l(),U(e),l(7),x(P(10,3,O(9,1,n.totalAmount$),"UYU","$","1.2-2"))}}function Z(s,t){s&1&&(a(0,"div",7)(1,"p"),d(2,"Tu carrito est\xE1 vac\xEDo. \xA1Agrega algunos productos deliciosos!"),c(),a(3,"a",24),d(4,"Ver Men\xFA"),c()())}function tt(s,t){s&1&&w(0,X,13,8)(1,Z,5,0,"div",7),s&2&&S(t.length>0?0:1)}function et(s,t){s&1&&(a(0,"div",5)(1,"p"),d(2,"Cargando tu carrito..."),c()())}function nt(s,t){if(s&1){let e=I();a(0,"div",6)(1,"button",25),h("click",function(){m(e);let o=u();return g(o.viewPurchaseHistory())}),d(2,"Ver Historial de Compras"),c()()}}var J=class s{constructor(t,e,n,o){this.cartService=t;this.authService=e;this.router=n;this.http=o;this.totalAmount$=this.cartItems$.pipe(y(i=>{let r=this.calculateTotal(i);return console.log("ShoppingCartComponent: Items being passed to calculateTotal (from totalAmount$ pipe):",i),console.log("ShoppingCartComponent: Calculated total (from totalAmount$ pipe):",r),r}))}cartItems$=new $([]);totalAmount$;currentUserSubscription;userId=null;showPurchaseHistoryButton=!1;editedQuantities=new Map;mercadoPagoBackendUrl="http://localhost:3000/create_preference";ngOnInit(){this.currentUserSubscription=this.authService.user$.pipe(T(t=>(this.userId=t?t.uid:null,console.log("ShoppingCartComponent: User ID after auth state change:",this.userId),this.userId?(this.checkPurchaseHistory(this.userId),this.cartService.getCart(this.userId)):(this.showPurchaseHistoryButton=!1,Q([])))),y(t=>(this.editedQuantities.clear(),console.log("ShoppingCartComponent: Carrito recibido (items crudos) del servicio y procesado:",t),t))).subscribe(t=>{this.cartItems$.next(t)})}ngOnDestroy(){this.currentUserSubscription&&this.currentUserSubscription.unsubscribe(),this.cartItems$.complete()}checkPurchaseHistory(t){this.cartService.getPurchaseHistory(t).pipe(E(1),y(e=>(console.log("ShoppingCartComponent: Historial de compras para checkPurchaseHistory:",e),e.length>0))).subscribe(e=>{this.showPurchaseHistoryButton=e,console.log("ShoppingCartComponent: \xBFTiene historial de compras?",e)})}calculateTotal(t){return console.log("calculateTotal: Recibiendo items para sumar:",t),t.reduce((e,n)=>{console.log(`calculateTotal: Sumando item: ${n.nombre}, Precio: ${n.precio}, Cantidad: ${n.cantidad}`);let o=typeof n.precio=="number"?n.precio:parseFloat(n.precio)||0,i=typeof n.cantidad=="number"?n.cantidad:parseInt(n.cantidad,10)||0,r=o*i;return console.log(`calculateTotal: Subtotal para ${n.nombre}: ${r}`),e+r},0)}onQuantityChange(t,e){let n=e.target,o=n.value.trim(),i;if(o==="")i=0;else{let p=parseInt(o,10);if(isNaN(p)||p<0){console.warn(`ShoppingCartComponent: Invalid entry for "${t.nombre}". Restored to ${t.cantidad}.`),n.value=String(t.cantidad);return}i=p}this.editedQuantities.set(t.id,i),console.log(`ShoppingCartComponent: Cantidad de "${t.nombre}" editada a ${i} (localmente).`);let r=this.cartItems$.getValue(),k=r.findIndex(p=>p.id===t.id);if(k>-1){let p=[...r];p[k]=C(b({},p[k]),{cantidad:i}),this.cartItems$.next(p)}}onQuantityBlur(t,e){let n=e.target,o=n.value.trim(),i=parseInt(o,10);if(isNaN(i)||i<0)i=1,this.editedQuantities.set(t.id,i),n.value=String(i),console.log(`ShoppingCartComponent: Invalid input for "${t.nombre}" on blur. Restored to 1.`);else if(i===0){this.removeItem(t),this.editedQuantities.delete(t.id);return}this.hasEditedQuantity(t)?(console.log(`ShoppingCartComponent: onQuantityBlur triggered for "${t.nombre}". Saving quantity.`),this.saveQuantity(t)):i===t.cantidad&&this.editedQuantities.has(t.id)&&this.editedQuantities.delete(t.id)}incrementQuantity(t){let e=this.editedQuantities.get(t.id);e===void 0&&(e=t.cantidad);let n=e+1;this.editedQuantities.set(t.id,n);let o=this.cartItems$.getValue(),i=o.findIndex(r=>r.id===t.id);if(i>-1){let r=[...o];r[i]=C(b({},r[i]),{cantidad:n}),this.cartItems$.next(r),this.saveQuantity(r[i])}console.log(`ShoppingCartComponent: Quantity of "${t.nombre}" incremented to ${n} (locally).`)}decrementQuantity(t){let e=this.editedQuantities.get(t.id);if(e===void 0&&(e=t.cantidad),e>0){let n=e-1;this.editedQuantities.set(t.id,n);let o=this.cartItems$.getValue(),i=o.findIndex(r=>r.id===t.id);if(i>-1){let r=[...o];r[i]=C(b({},r[i]),{cantidad:n}),this.cartItems$.next(r),n===0?this.removeItem(r[i]):this.saveQuantity(r[i])}console.log(`ShoppingCartComponent: Quantity of "${t.nombre}" decremented to ${n} (locally).`)}else console.log(`ShoppingCartComponent: Quantity of "${t.nombre}" is already 0, cannot decrement further.`)}hasEditedQuantity(t){let e=this.editedQuantities.get(t.id);return e!==void 0&&e!==t.cantidad}saveQuantity(t){return v(this,null,function*(){if(!this.userId||!t.id){alert("Error: No se pudo identificar al usuario o al producto.");return}let e=this.editedQuantities.get(t.id);if(e===void 0){console.log(`ShoppingCartComponent: No quantity change for "${t.nombre}" to save.`);return}if(e===0){this.removeItem(t),this.editedQuantities.delete(t.id);return}if(isNaN(e)||e<0){alert("Por favor, ingresa una cantidad v\xE1lida (mayor o igual a cero)."),this.editedQuantities.delete(t.id);let n=this.cartItems$.getValue(),o=n.find(i=>i.id===t.id);if(o){let i=n.map(r=>r.id===t.id?C(b({},r),{cantidad:o.cantidad}):r);this.cartItems$.next(i)}return}try{yield this.cartService.updateItemQuantity(this.userId,t.id,e),console.log(`ShoppingCartComponent: Cantidad de "${t.nombre}" actualizada a ${e} en Firebase.`),this.editedQuantities.delete(t.id)}catch(n){console.error("ShoppingCartComponent: Error al actualizar la cantidad en Firebase:",n),alert("Error al actualizar la cantidad. Por favor, int\xE9ntalo de nuevo.")}})}removeItem(t){return v(this,null,function*(){if(!this.userId||!t.id){alert("Error: No se pudo identificar al usuario o al producto para eliminar.");return}if(confirm(`\xBFEst\xE1s seguro de que quieres eliminar "${t.nombre}" del carrito?`))try{yield this.cartService.removeItemFromCart(this.userId,t.id),alert(`"${t.nombre}" eliminado del carrito.`),console.log(`ShoppingCartComponent: "${t.nombre}" eliminado del carrito en Firebase.`),this.editedQuantities.delete(t.id)}catch(e){console.error("ShoppingCartComponent: Error al eliminar el item del carrito en Firebase:",e),alert("Error al eliminar el item del carrito. Por favor, int\xE9ntalo de nuevo.")}})}checkout(){return v(this,null,function*(){if(!this.userId){alert("Debes iniciar sesi\xF3n para completar la compra.");return}let t=this.cartItems$.getValue();if(t.length===0){alert("Tu carrito est\xE1 vac\xEDo. Agrega productos antes de comprar.");return}let e=t.map(n=>({title:n.nombre,quantity:n.cantidad,unit_price:n.precio}));try{let n=yield this.http.post(this.mercadoPagoBackendUrl,{items:e}).toPromise();n&&n.init_point?(console.log("Mercado Pago Preference created:",n.id),console.log("Redirecting to:",n.init_point),window.location.href=n.init_point):(alert("Error al iniciar el pago con Mercado Pago: No se recibi\xF3 un punto de inicio v\xE1lido."),console.error("Mercado Pago Backend response missing init_point:",n))}catch(n){console.error("Error al crear la preferencia de Mercado Pago:",n),alert("Ocurri\xF3 un error al procesar tu pago con Mercado Pago. Por favor, int\xE9ntalo de nuevo.")}})}viewPurchaseHistory(){this.router.navigate(["/purchase-history"])}static \u0275fac=function(e){return new(e||s)(_(G),_(L),_(R),_(j))};static \u0275cmp=F({type:s,selectors:[["app-shopping-cart"]],decls:11,vars:4,consts:[[1,"cart-main-container"],[1,"cart-content-wrapper"],[1,"back-button-container"],["routerLink","/",1,"back-button"],[1,"cart-title"],[1,"loading-message-cart"],[1,"purchase-history-button-container"],[1,"empty-cart-message"],[1,"cart-items-grid"],[1,"cart-item-card"],[1,"cart-summary"],[1,"total-section"],[1,"total-amount"],[1,"checkout-button",3,"click"],[1,"cart-item-image",3,"src","alt"],[1,"item-details"],[1,"item-name"],[1,"item-price"],[1,"item-controls"],[1,"quantity-button","minus-button",3,"click"],["type","number","min","0",1,"item-quantity-input",3,"input","blur","value"],[1,"quantity-button","plus-button",3,"click"],[1,"remove-item-button",3,"click"],[1,"item-subtotal"],["routerLink","/",1,"back-to-menu-button"],[1,"view-history-button",3,"click"]],template:function(e,n){if(e&1&&(a(0,"div",0)(1,"div",1)(2,"div",2)(3,"a",3),d(4,"\u2190 Seguir Comprando"),c()(),a(5,"h1",4),d(6,"Tu Carrito de Compras"),c(),w(7,tt,2,1),f(8,"async"),z(9,et,3,0,"div",5),w(10,nt,3,0,"div",6),c()()),e&2){let o;l(7),S((o=O(8,2,n.cartItems$))?7:9,o),l(3),S(n.showPurchaseHistoryButton?10:-1)}},dependencies:[N,Y,D,q,A],styles:[".cart-main-container[_ngcontent-%COMP%]{min-height:100vh;background-color:#1a202c;color:#e2e8f0;padding:2rem;font-family:sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;display:flex;flex-direction:column;align-items:center}.cart-content-wrapper[_ngcontent-%COMP%]{max-width:800px;width:100%;margin:0 auto;background-color:#2d3748;border-radius:.5rem;box-shadow:0 20px 25px -5px #0000001a,0 10px 10px -5px #0000000a;overflow:hidden;padding:2rem;position:relative}.back-button-container[_ngcontent-%COMP%]{margin-bottom:1.5rem}.back-button[_ngcontent-%COMP%]{display:inline-block;background-color:#4a5568;color:#e2e8f0;padding:.75rem 1.5rem;border-radius:.5rem;text-decoration:none;font-weight:600;transition:background-color .3s ease}.back-button[_ngcontent-%COMP%]:hover{background-color:#64748b}.company-logo-container[_ngcontent-%COMP%]{text-align:center;margin-bottom:2rem}.company-logo[_ngcontent-%COMP%]{max-width:150px;height:auto;display:inline-block}.cart-title[_ngcontent-%COMP%]{font-size:2.5rem;font-weight:800;text-align:center;margin-bottom:2rem;color:#f6e05e;font-family:Pacifico,cursive;text-shadow:2px 2px 4px rgba(0,0,0,.5)}.cart-items-grid[_ngcontent-%COMP%]{display:grid;gap:1.5rem;margin-bottom:2rem}.cart-item-card[_ngcontent-%COMP%]{display:flex;align-items:center;background-color:#1a202c;border-radius:.5rem;box-shadow:0 5px 15px #0003;padding:1rem;gap:1rem;flex-wrap:wrap}.cart-item-image[_ngcontent-%COMP%]{width:80px;height:80px;border-radius:.375rem;object-fit:cover;flex-shrink:0}.item-details[_ngcontent-%COMP%]{flex-grow:1}.item-name[_ngcontent-%COMP%]{font-size:1.25rem;font-weight:700;color:#fff;margin-bottom:.25rem}.item-price[_ngcontent-%COMP%]{font-size:1rem;color:#a0aec0}.item-controls[_ngcontent-%COMP%]{display:flex;align-items:center;flex-shrink:0;margin-top:.5rem;width:100%;justify-content:center;border:1px solid #4a5568;border-radius:.375rem;overflow:hidden}@media (min-width: 640px){.item-controls[_ngcontent-%COMP%]{width:auto;margin-top:0;justify-content:flex-start}}.quantity-button[_ngcontent-%COMP%]{background-color:#4a5568;color:#fff;border:none;width:35px;height:35px;font-size:1.2rem;font-weight:700;cursor:pointer;transition:background-color .2s ease;display:flex;align-items:center;justify-content:center;flex-shrink:0}.quantity-button[_ngcontent-%COMP%]:hover{background-color:#64748b}.quantity-button.minus-button[_ngcontent-%COMP%]{border-top-left-radius:.375rem;border-bottom-left-radius:.375rem;border-top-right-radius:0;border-bottom-right-radius:0}.quantity-button.plus-button[_ngcontent-%COMP%]{border-top-right-radius:.375rem;border-bottom-right-radius:.375rem;border-top-left-radius:0;border-bottom-left-radius:0}.item-quantity-input[_ngcontent-%COMP%]{width:60px;padding:.5rem;border:none;border-radius:0;background-color:#1a202c;color:#e2e8f0;font-size:1rem;text-align:center;appearance:textfield;-moz-appearance:textfield;box-sizing:border-box}.item-quantity-input[_ngcontent-%COMP%]::-webkit-outer-spin-button, .item-quantity-input[_ngcontent-%COMP%]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}.remove-item-button[_ngcontent-%COMP%]{background-color:#e53e3e;color:#fff;padding:.5rem 1rem;border:none;border-radius:.375rem;font-size:.9rem;font-weight:600;cursor:pointer;transition:background-color .2s ease;margin-left:.75rem}.remove-item-button[_ngcontent-%COMP%]:hover{background-color:#c53030}.item-subtotal[_ngcontent-%COMP%]{font-size:1.25rem;font-weight:700;color:#f6e05e;flex-shrink:0;margin-left:auto}@media (max-width: 639px){.cart-item-card[_ngcontent-%COMP%]{flex-direction:column;align-items:flex-start}.item-details[_ngcontent-%COMP%]{width:100%}.item-subtotal[_ngcontent-%COMP%]{margin-left:0;width:100%;text-align:right;margin-top:.5rem}}.cart-summary[_ngcontent-%COMP%]{background-color:#1a202c;border-radius:.5rem;padding:1.5rem;box-shadow:0 5px 15px #0003;display:flex;flex-direction:column;gap:1.5rem}.total-section[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;font-size:1.5rem;font-weight:700;color:#fff}.total-amount[_ngcontent-%COMP%]{color:#f6e05e;font-size:2rem}.checkout-button[_ngcontent-%COMP%]{width:100%;background-color:#48bb78;color:#1a202c;padding:1rem 2rem;border:none;border-radius:.5rem;font-size:1.25rem;font-weight:700;cursor:pointer;transition:background-color .3s ease,transform .1s ease;box-shadow:0 4px 6px #0000001a}.checkout-button[_ngcontent-%COMP%]:hover{background-color:#38a169;transform:translateY(-2px)}.checkout-button[_ngcontent-%COMP%]:active{transform:translateY(0);box-shadow:0 2px 4px #0000001a}.empty-cart-message[_ngcontent-%COMP%], .loading-message-cart[_ngcontent-%COMP%]{text-align:center;padding:3rem;font-size:1.25rem;color:#a0aec0}.back-to-menu-button[_ngcontent-%COMP%]{display:inline-block;margin-top:1.5rem;background-color:#c53030;color:#fff;padding:.75rem 1.5rem;border-radius:.5rem;text-decoration:none;font-weight:600;transition:background-color .3s ease}.back-to-menu-button[_ngcontent-%COMP%]:hover{background-color:#a02020}.purchase-history-button-container[_ngcontent-%COMP%]{margin-top:2rem;text-align:center}.view-history-button[_ngcontent-%COMP%]{background-color:#007bff;color:#fff;padding:.75rem 1.5rem;border:none;border-radius:.5rem;font-size:1rem;font-weight:600;cursor:pointer;transition:background-color .3s ease,transform .1s ease;box-shadow:0 2px 4px #0000001a}.view-history-button[_ngcontent-%COMP%]:hover{background-color:#0056b3;transform:translateY(-1px)}.view-history-button[_ngcontent-%COMP%]:active{transform:translateY(0);box-shadow:0 1px 2px #0000001a}"]})};export{J as ShoppingCartComponent};
